<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lista Libri (Google Sheet)</title>
<style>
  *, *::before, *::after { box-sizing: border-box; }

  body{ font-family: Arial, Helvetica, sans-serif; margin:0; padding:16px; background:#e8f5e9; color:#1b5e20; }
  h1{ text-align:center; margin:8px 0 12px; font-size:20px; }

  #searchBar{ width:100%; padding:12px 14px; border-radius:10px; border:2px solid #66bb6a; font-size:16px; }

  table{ width:100%; border-collapse:collapse; margin-top:12px; }
  th, td{ padding:12px; border-bottom:2px solid #c8e6c9; vertical-align:middle; }
  th{ background:#4caf50; color:#fff; text-align:left; }
  td:first-child{ width:45px; text-align:center; }
  td:last-child{ width:100px; text-align:center; }

  tr.checked td:nth-child(2){ text-decoration:line-through; color:#2e7d32; }

  #inputContainer{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
  #newBook{ flex:1; padding:14px; border-radius:10px; border:2px solid #66bb6a; font-size:16px; }
  #addBtn{ padding:12px 10px; border-radius:10px; border:none; background:#4caf50; color:#fff; font-size:15px; cursor:pointer; flex:0 0 auto; }
  #addBtn:active{ transform:translateY(1px); }
  #downloadBtn{ width:100%; margin-top:10px; padding:12px; border-radius:10px; border:none; background:#4caf50; color:#fff; font-size:16px; cursor:pointer; }
  .remove-btn{ background:transparent; color:#b71c1c; border:none; cursor:pointer; padding:8px; font-size:14px; }
  .remove-btn:hover{ color:red; }
  #status{ font-size:13px; color:#2e7d32; margin-top:8px; opacity:0.95; }

  @media (max-width:520px){
    th, td{ font-size:14px; padding:10px; }
    #newBook{ font-size:16px; padding:12px; }
    #addBtn{ padding:12px; font-size:15px; width:auto; }
  }
</style>
</head>
<body>

<h1>Lista Libri Sezione Verde 📚</h1>

<input id="searchBar" placeholder="🔍 Cerca un libro..." oninput="searchBooks()" />

<table id="listaLibri" aria-label="Lista libri">
  <thead>
    <tr><th></th><th>Titolo</th><th>Rimuovi</th></tr>
  </thead>
  <tbody></tbody>
</table>

<div id="inputContainer">
  <input id="newBook" placeholder="Aggiungi un nuovo libro..." />
  <button id="addBtn" onclick="addBook()">+ Aggiungi</button>
</div>

<button id="downloadBtn" onclick="downloadPDF()">📄 Scarica PDF</button>

<div id="status" aria-live="polite"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbyyNMFHrxHew8ehuKmgf7DO-HLcav8Sj8HIQWHwK8tLppY2_JIuEqTwLenNeG9d8CdH/exec";

const libriIniziali = [
"Il gufo","Sotto la pioggia di Nicoletta Costa","Orecchie di farfalla di Luisa Aguilar",
"La cena di Natale di Daniel Dargent, Magali Le Huche","La buca di Emma Adbåge",
"Sulla collina di Linda Sarah, EDT-Giralangolo, 2015","Hai visto la mia coda di Alberto Lot",
"Il cucciolo di Nina di Christine Naumann-Villemin, Il Castoro, 2003","Balena serena di Eric Battut, I Bohemien",
"Rulba Rulba di Bussolati, Ed. Carthusia","Piccolo coccodrillo va al parco di Eva Montanari, Babalibri",
"Domani a scuola di Emile Jadoul, Babalibri","Il mondo a testa in giù di Mario Ramos, Babalibri",
"Sono il rinoceronte di Geoffroy de Pennart, Babalibri","Ruby e la storia di quando incontrò una preoccupazione di Tom Percival, Giunti",
"Cappuccetto Verde di Bruno Munari, Corraini","Bastoncino di Julia Donaldson, Emme Edizioni",
"Piccolo riccio non vuole dormire di Maria Loretta Giraldo, Giunti",
"Come ti senti oggi? Il libro delle emozioni di Molly Potter, Giunti Editore",
"Lucy e il filo dell’amicizia di Vanessa Roeder, Edizioni Terre di Mezzo",
"Gaia e Maia uguali ma diverse di Mylo Freeman",
"A chi somiglio di Yu Jin, Edizioni Terre di Mezzo","Un gioco da ragazze di Alessandra Lazzarin, Edizioni Orecchio Acerbo",
"Federica e Federico di Irene Biemmi, Giunti Kids","Se vuoi vedere una balena, Bababum",
"Papa Isola, Bababum","La casa più grande del mondo, Bababum","Io sono adesso, Babalibri",
"La sedia blu, Bababum"
];

let libri = libriIniziali.map(t => ({ flag:false, titolo:t }));
let saveTimer = null;
const SAVE_DELAY = 800;
let remoteLoaded = false;

const tbody = document.querySelector("#listaLibri tbody");
const statusEl = document.getElementById("status");
const searchInput = document.getElementById("searchBar");

function renderList() {
  tbody.innerHTML="";
  libri.forEach((l,i)=>{
    if(!l || !l.titolo) return;
    const tr=document.createElement("tr");
    if(l.flag) tr.classList.add("checked");

    const tdFlag=document.createElement("td");
    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.checked=!!l.flag;
    cb.addEventListener("change",()=>{
      l.flag=cb.checked;
      scheduleSave();
      if(l.flag) tr.classList.add("checked"); else tr.classList.remove("checked");
    });
    tdFlag.appendChild(cb);

    const tdTit=document.createElement("td"); tdTit.textContent=l.titolo;

    const tdRm=document.createElement("td");
    const btn=document.createElement("button");
    btn.className="remove-btn";
    btn.textContent="Rimuovi";
    btn.addEventListener("click",()=>{
      libri.splice(i,1);
      scheduleSave();
      renderList();
    });
    tdRm.appendChild(btn);

    tr.appendChild(tdFlag); tr.appendChild(tdTit); tr.appendChild(tdRm);
    tbody.appendChild(tr);
  });
  searchBooks();
}

async function fetchRemote(){
  setStatus("Caricamento dati dal server...");
  try{
    const res=await fetch(SHEET_URL);
    if(!res.ok) throw new Error("HTTP "+res.status);
    const text=await res.text();
    const data=JSON.parse(text);
    const filtered=data.filter(r=>r&&r[1]&&r[1].toString().trim()!=="");
    if(filtered.length>0){
      libri=filtered.map(r=>({flag:!!r[0], titolo:String(r[1])}));
      remoteLoaded=true;
      setStatus("Sincronizzato con Google Sheet.");
      renderList();
    } else{
      setStatus("Foglio vuoto: inizializzo lista...");
      await saveNow();
      remoteLoaded=true;
      setStatus("Inizializzazione completata.");
    }
  }catch(err){
    console.warn("Errore caricamento remote:",err);
    setStatus("Offline o errore server: uso dati locali.");
    renderList();
  }
}

function scheduleSave(){
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer=setTimeout(()=>{ saveNow(); },SAVE_DELAY);
}

async function saveNow(){
  try{
    setStatus("Salvataggio in corso...");
    const payload=libri.map(l=>[!!l.flag,l.titolo||""]);
    const res=await fetch(SHEET_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    setStatus("Salvato su Google Sheet.");
  }catch(err){
    console.error("Errore salvataggio:",err);
    setStatus("Errore salvataggio (controlla connessione).");
  }
}

function addBook(){
  const val=document.getElementById("newBook").value.trim();
  if(!val) return;
  libri.push({flag:false,titolo:val});
  document.getElementById("newBook").value="";
  renderList();
  scheduleSave();
  setTimeout(()=>{ window.scrollTo({top:document.body.scrollHeight, behavior:"smooth"}); },120);
}

function searchBooks(){
  const q=searchInput.value.toLowerCase();
  document.querySelectorAll("#listaLibri tbody tr").forEach(row=>{
    const tit=row.querySelector("td:nth-child(2)").textContent.toLowerCase();
    row.style.display = tit.includes(q) ?
